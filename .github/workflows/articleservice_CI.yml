name: Article Service CI

on:
  push:
    branches:
      - main
    paths:
      - 'ArticleService/**'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        workload_identity_provider: 'projects/1030920709279/locations/global/workloadIdentityPools/wotc-scraper-pool/providers/wotc-scraper-provider'
        service_account: 'github-ci-service-account@mtg-scraper-385015.iam.gserviceaccount.com'

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9' 

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r ArticleService/requirements.txt

    - name: Install linters
      run: |
        pip install pylint flake8

    - name: Set PYTHONPATH
      run: echo "PYTHONPATH=$PYTHONPATH:$(pwd)/ArticleService" >> $GITHUB_ENV

    - name: Set up CI variable
      run: |
        echo "CI_PIPELINE=true" >> $GITHUB_ENV

    - name: Run pylint
      run: |
        pylint --rcfile=ArticleService/.pylintrc ArticleService/src ArticleService/tests

    - name: Run flake8
      run: |
        flake8 --config=ArticleService/.flake8 ArticleService/src ArticleService/tests

    - name: Run unit tests
      run: |
        pytest ArticleService/tests/unit

    - name: Run integration tests
      run: |
        pytest -m integration ArticleService/tests/integration/

    - name: Run performance tests
      run: |
        pytest -m performance ArticleService/tests/performance/

    - name: Build Python package
      run: |
        python -m pip install --upgrade setuptools wheel 'build<0.10.0'
        python -m build ./ArticleService --sdist --wheel

    - name: Set Google Cloud credentials
      run: |
        echo "$GOOGLE_APPLICATION_CREDENTIALS" | base64 --decode > /tmp/keyfile.json
        gcloud auth activate-service-account --key-file=/tmp/keyfile.json
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_BASE64 }}
      

    - name: Set up .pypirc
      run: |
        gcloud artifacts print-settings python --project=mtg-scraper-385015 --repository=dev-projects --location=europe-west6 >> ~/.pypirc

    - name: Publish Package to Artifact Registry
      run: |
        python -m pip install twine
        twine upload -r dev-projects ./dist/*
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

    
      
