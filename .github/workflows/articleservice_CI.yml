name: Article Service CI

on:
  push:
    branches:
      - main
    paths:
      - 'ArticleService/**'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        workload_identity_provider: 'projects/1030920709279/locations/global/workloadIdentityPools/wotc-scraper-pool/providers/wotc-scraper-provider'
        service_account: 'github-ci-service-account@mtg-scraper-385015.iam.gserviceaccount.com'

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9' 

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r ArticleService/requirements.txt

    - name: Install linters
      run: |
        pip install pylint flake8

    - name: Set PYTHONPATH
      run: echo "PYTHONPATH=$PYTHONPATH:$(pwd)/ArticleService" >> $GITHUB_ENV

    - name: Set up CI variable
      run: |
        echo "CI_PIPELINE=true" >> $GITHUB_ENV

    - name: Run pylint
      run: |
        pylint --rcfile=ArticleService/.pylintrc ArticleService/src ArticleService/tests

    - name: Run flake8
      run: |
        flake8 --config=ArticleService/.flake8 ArticleService/src ArticleService/tests

    - name: Run unit tests
      run: |
        pytest ArticleService/tests/unit

    - name: Run integration tests
      run: |
        pytest -m integration ArticleService/tests/integration/

    - name: Run performance tests
      run: |
        pytest -m performance ArticleService/tests/performance/

    - name: Build Python package
      run: |
        python -m pip install --upgrade setuptools wheel 'build<0.10.0'
        python -m build ./ArticleService --sdist --wheel

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v0.3.0
      with:
          project_id: mtg-scraper-385015
          service_account_key: ${{ secrets.GCP_SA_KEY }}
              
    - name: Generate Key File
      run: |
        gcloud iam service-accounts keys create ./key_github_ci_user.json --iam-account=github-ci-service-account@mtg-scraper-385015.iam.gserviceaccount.com
    
    - name: Authenticate gcloud with service account key
      run: |
        gcloud auth activate-service-account --key-file=key_github_ci_user.json
    
    - name: Set GOOGLE_APPLICATION_CREDENTIALS
      run: echo "GOOGLE_APPLICATION_CREDENTIALS=${{ github.workspace }}/key_github_ci_user.json" >> $GITHUB_ENV
    
    - name: Set up .pypirc
      run: |
        gcloud artifacts print-settings python --project=mtg-scraper-385015 --repository=dev-projects --location=europe-west6 > ~/.pypirc
        
    - name: Publish Package to Artifact Registry
      run: |
        python -m pip install twine
        twine upload -r dev-projects ./ArticleService/dist/*
      
      
      
